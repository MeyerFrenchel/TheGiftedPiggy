---
export const prerender = false;

import AdminLayout from '@layouts/AdminLayout.astro';
import AdminProductForm from '@components/admin/AdminProductForm.astro';
import { createSSRClient } from '@lib/supabase';
import { parseProductFormData, updateProduct, getProduct } from '@lib/products';

const { id } = Astro.params;
if (!id) return Astro.redirect('/admin/products');

const supabase = createSSRClient({ request: Astro.request, cookies: Astro.cookies });

const { data: { session } } = await supabase.auth.getSession();
const accessToken = session?.access_token ?? '';
const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;

let errorMsg = '';

if (Astro.request.method === 'POST') {
  const form = await Astro.request.formData();
  const result = await updateProduct(supabase, id, parseProductFormData(form));
  if (!result.success) {
    errorMsg = result.error;
  } else {
    return Astro.redirect(`/admin/products/${id}`);
  }
}

const productResult = await getProduct(supabase, id);
if (!productResult.success) return Astro.redirect('/admin/products');
const product = productResult.data;
---

<AdminLayout title={`Edit: ${product.name}`}>
  {errorMsg && (
    <div style="background:#fee2e2;color:#dc2626;padding:0.75rem 1rem;border-radius:6px;margin-bottom:1rem;font-size:0.875rem;">
      {errorMsg}
    </div>
  )}
  <div style="background:#fff;border:1px solid #e5e7eb;border-radius:10px;padding:1.5rem;">
    <AdminProductForm {product} {accessToken} {supabaseUrl} />
  </div>
</AdminLayout>
