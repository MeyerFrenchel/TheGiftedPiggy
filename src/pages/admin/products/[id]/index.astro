---
export const prerender = false;

import AdminLayout from '@layouts/AdminLayout.astro';
import DeleteProductButton from '@components/admin/DeleteProductButton';
import { createSSRClient } from '@lib/supabase';
import { deleteProduct, getProduct } from '@lib/products';

const { id } = Astro.params;
if (!id) return Astro.redirect('/admin/products');

const supabase = createSSRClient({ request: Astro.request, cookies: Astro.cookies });

// Handle delete POST
if (Astro.request.method === 'POST') {
  const form = await Astro.request.formData();
  if (form.get('action') === 'delete') {
    await deleteProduct(supabase, id);
    return Astro.redirect('/admin/products');
  }
}

const productResult = await getProduct(supabase, id);
if (!productResult.success) return Astro.redirect('/admin/products');
const product = productResult.data;

const formattedPrice = new Intl.NumberFormat('ro-RO', {
  style: 'currency',
  currency: product.currency,
  minimumFractionDigits: 0,
}).format(product.price);
---

<AdminLayout title={product.name}>
  <style>
    .product-detail { background: #fff; border: 1px solid #e5e7eb; border-radius: 10px; padding: 1.5rem; }
    .detail-grid { display: grid; grid-template-columns: 280px 1fr; gap: 2rem; }
    .product-img { width: 100%; aspect-ratio: 1; object-fit: cover; border-radius: 8px; border: 1px solid #e5e7eb; }
    .product-img-placeholder { width: 100%; aspect-ratio: 1; background: #f3f4f6; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 4rem; }
    .meta-row { display: flex; flex-direction: column; gap: 0.75rem; }
    .meta-item label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.05em; color: #9ca3af; font-weight: 600; }
    .meta-item .val { font-size: 0.9rem; color: #111; margin-top: 0.125rem; }
    .badge { display: inline-flex; padding: 0.2rem 0.5rem; border-radius: 999px; font-size: 0.7rem; font-weight: 600; }
    .badge-green { background: #dcfce7; color: #16a34a; }
    .badge-red { background: #fee2e2; color: #dc2626; }
    .badge-purple { background: #ede9fe; color: #7c3aed; }
    .action-bar { display: flex; gap: 0.75rem; align-items: center; flex-wrap: wrap; margin-top: 1.5rem; padding-top: 1.25rem; border-top: 1px solid #e5e7eb; }
    .btn-edit { padding: 0.5rem 1rem; background: #8b5cf6; color: #fff; border-radius: 6px; text-decoration: none; font-size: 0.875rem; font-weight: 600; }
    .btn-back { padding: 0.5rem 1rem; background: #f3f4f6; color: #374151; border-radius: 6px; text-decoration: none; font-size: 0.875rem; }
    .description-block { margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #f3f4f6; }
    .description-block h3 { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #9ca3af; font-weight: 600; margin-bottom: 0.375rem; }
    .description-block p { font-size: 0.875rem; color: #374151; line-height: 1.6; }
    @media (max-width: 600px) {
      .product-detail { padding: 1rem; }
      .detail-grid { grid-template-columns: 1fr; gap: 1.25rem; }
      .product-img, .product-img-placeholder { width: 100%; }
      .action-bar { flex-direction: column; align-items: stretch; }
      .action-bar a, .action-bar button { text-align: center; justify-content: center; }
    }
  </style>

  <div class="product-detail">
    <div class="detail-grid">
      <div>
        {product.image_url
          ? <img src={product.image_url} alt={product.image_alt ?? ''} class="product-img" />
          : <div class="product-img-placeholder">üéÅ</div>
        }
      </div>

      <div>
        <div class="meta-row">
          <div class="meta-item">
            <label>Slug</label>
            <div class="val" style="font-family:monospace;font-size:0.8rem;background:#f9fafb;padding:0.25rem 0.5rem;border-radius:4px;display:inline-block">{product.slug}</div>
          </div>
          <div class="meta-item">
            <label>Name (RO)</label>
            <div class="val">{product.name}</div>
          </div>
          {product.name_en && (
            <div class="meta-item">
              <label>Name (EN)</label>
              <div class="val">{product.name_en}</div>
            </div>
          )}
          <div class="meta-item">
            <label>Price</label>
            <div class="val" style="font-size:1.1rem;font-weight:700;color:#7c3aed">{formattedPrice}</div>
          </div>
          {product.category && (
            <div class="meta-item">
              <label>Category</label>
              <div class="val">{product.category}</div>
            </div>
          )}
          <div class="meta-item">
            <label>Status</label>
            <div style="display:flex;gap:0.375rem;flex-wrap:wrap;margin-top:0.125rem">
              <span class={`badge ${product.in_stock ? 'badge-green' : 'badge-red'}`}>
                {product.in_stock ? 'In Stock' : 'Out of Stock'}
              </span>
              {product.featured && <span class="badge badge-purple">‚òÖ Featured</span>}
            </div>
          </div>
          {(product.tags ?? []).length > 0 && (
            <div class="meta-item">
              <label>Tags</label>
              <div style="display:flex;gap:0.375rem;flex-wrap:wrap;margin-top:0.25rem">
                {(product.tags ?? []).map((tag) => (
                  <span style="background:#f3f4f6;color:#374151;font-size:0.7rem;padding:0.125rem 0.5rem;border-radius:999px">{tag}</span>
                ))}
              </div>
            </div>
          )}
        </div>

        {product.description && (
          <div class="description-block">
            <h3>Description (RO)</h3>
            <p>{product.description}</p>
          </div>
        )}
        {product.description_en && (
          <div class="description-block">
            <h3>Description (EN)</h3>
            <p>{product.description_en}</p>
          </div>
        )}
      </div>
    </div>

    <div class="action-bar">
      <a href={`/admin/products/${id}/edit`} class="btn-edit">Edit</a>
      <a href="/admin/products" class="btn-back">‚Üê Back to Products</a>
      <DeleteProductButton
        client:load
        productId={id}
        productName={product.name}
      />
    </div>
  </div>
</AdminLayout>
