---
export const prerender = false;

import AdminLayout from '@layouts/AdminLayout.astro';
import { createSSRClient } from '@lib/supabase';

const supabase = createSSRClient({ request: Astro.request, cookies: Astro.cookies });
const { data: products } = await supabase
  .from('products')
  .select('*')
  .order('created_at', { ascending: false });
---

<AdminLayout title="Products">
  <style>
    .toolbar {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 1rem;
    }
    .btn-add {
      display: inline-flex;
      align-items: center;
      gap: 0.375rem;
      padding: 0.5rem 1rem;
      background: #8b5cf6;
      color: #fff;
      border-radius: 6px;
      text-decoration: none;
      font-size: 0.875rem;
      font-weight: 600;
    }
    .btn-add:hover { background: #7c3aed; }
    .table-wrap { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 10px; border: 1px solid #e5e7eb; }
    table { width: 100%; border-collapse: collapse; background: #fff; min-width: 560px; }
    th { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.04em; color: #6b7280; padding: 0.75rem 1rem; text-align: left; background: #f9fafb; border-bottom: 1px solid #e5e7eb; white-space: nowrap; }
    td { padding: 0.75rem 1rem; font-size: 0.875rem; border-bottom: 1px solid #f3f4f6; vertical-align: middle; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: #fafafa; }
    .thumb { width: 48px; height: 48px; object-fit: cover; border-radius: 6px; border: 1px solid #e5e7eb; }
    .thumb-placeholder { width: 48px; height: 48px; background: #f3f4f6; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 1.25rem; }
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 600;
    }
    .badge-green { background: #dcfce7; color: #16a34a; }
    .badge-red { background: #fee2e2; color: #dc2626; }
    .badge-purple { background: #ede9fe; color: #7c3aed; }
    .actions { display: flex; gap: 0.375rem; }
    .action-link {
      padding: 0.25rem 0.625rem;
      border-radius: 5px;
      font-size: 0.75rem;
      font-weight: 600;
      text-decoration: none;
      white-space: nowrap;
    }
    .action-view { background: #f3f4f6; color: #374151; }
    .action-edit { background: #ede9fe; color: #7c3aed; }
    .empty { text-align: center; color: #9ca3af; padding: 3rem; }
  </style>

  <div class="toolbar">
    <a href="/admin/products/new" class="btn-add">+ New Product</a>
  </div>

  <div class="table-wrap">
  <table>
    <thead>
      <tr>
        <th>Image</th>
        <th>Name</th>
        <th>Category</th>
        <th>Price</th>
        <th>Status</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {(products ?? []).length === 0 && (
        <tr><td colspan="6" class="empty">No products yet.</td></tr>
      )}
      {(products ?? []).map((p) => (
        <tr>
          <td>
            {p.image_url
              ? <img src={p.image_url} alt={p.image_alt ?? ''} class="thumb" />
              : <div class="thumb-placeholder">üéÅ</div>
            }
          </td>
          <td>
            <strong>{p.name}</strong>
            {p.name_en && <div style="color:#9ca3af;font-size:0.75rem">{p.name_en}</div>}
          </td>
          <td>{p.category ?? '‚Äî'}</td>
          <td style="white-space:nowrap">
            {new Intl.NumberFormat('ro-RO', { style: 'currency', currency: p.currency, minimumFractionDigits: 0 }).format(p.price)}
          </td>
          <td>
            <div style="display:flex;flex-direction:column;gap:0.25rem">
              <span class={`badge ${p.in_stock ? 'badge-green' : 'badge-red'}`}>
                {p.in_stock ? 'In Stock' : 'Out of Stock'}
              </span>
              {p.featured && <span class="badge badge-purple">‚òÖ Featured</span>}
            </div>
          </td>
          <td>
            <div class="actions">
              <a href={`/admin/products/${p.id}`} class="action-link action-view">View</a>
              <a href={`/admin/products/${p.id}/edit`} class="action-link action-edit">Edit</a>
            </div>
          </td>
        </tr>
      ))}
    </tbody>
  </table>
  </div>
</AdminLayout>
